name: oci

on:
  push:
    branches: 
      - main
  workflow_dispatch:

jobs:
  oci:
    name: 'oci_policies_validation'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
  
    - name: setup
      run: |
        echo hello world
        ls -lt
        pwd
        cat config
        sed -i "s/OCI_USER_ID/${{vars.OCI_USER_ID}}/g" "config"
        sed -i "s/OCI_FINGER_PRINT_ID/${{vars.OCI_FINGER_PRINT_ID}}/g" "config"
        sed -i "s/OCI_TENANCY_ID/${{vars.OCI_TENANCY_ID}}/g" "config"
        sed -i "s/OCI_REGION/${{vars.OCI_REGION}}/g" "config"
        cat config
        sudo apt update && sudo apt upgrade -y
        sudo apt install python3
        pip install oci-cli
        wget https://releases.hashicorp.com/terraform/1.4.1/terraform_1.4.1_linux_amd64.zip
        sudo unzip terraform_1.4.1_linux_amd64.zip -d /usr/local/bin <<< "y"
        oci --help
        terraform --help
        terraform --version
        oci --version
        oci setup repair-file-permissions --file /home/runner/work/OCIPolicyMgmt/OCIPolicyMgmt/config
        oci setup repair-file-permissions --file /home/runner/work/OCIPolicyMgmt/OCIPolicyMgmt/oci_api_key.pem 
        python --version
        python validate_generate_policies.py
   
    - name: check oci
      run: |
        #oci os ns get --config-file /home/runner/work/OCIPolicyMgmt/OCIPolicyMgmt/config --profile "DEFAULT" --debug
        #oci os bucket list -c ocid1.compartment.oc1..aaaaaaaaoorr4zezczh4zsq2kcngjbeic7d66eh5xfifkid2gth4kcxwirra --namespace ${{vars.OCI_NAMESPACE}} --config-file /home/runner/work/OCIPolicyMgmt/OCIPolicyMgmt/config --profile "DEFAULT" --debug
        oci iam policy get --policy-id ocid1.policy.oc1..aaaaaaaa4bdnoglzmbaguftcb5wzzjuar3fc6fepfwplxpay3gosbbavovjq --config-file /home/runner/work/OCIPolicyMgmt/OCIPolicyMgmt/config --profile "DEFAULT" --debug >> current1_policy_state.json
        ls -lt
        cat current1_policy_state.json
        oci iam policy list -c ocid1.compartment.oc1..aaaaaaaaoorr4zezczh4zsq2kcngjbeic7d66eh5xfifkid2gth4kcxwirra --name test_policies_automation --config-file /home/runner/work/OCIPolicyMgmt/OCIPolicyMgmt/config --profile "DEFAULT" --debug >> current1_policy_list.json
        ls -lt
        cat current1_policy_list.json
        #yes | oci iam policy update --description "test description and update1" --policy-id ocid1.policy.oc1..aaaaaaaa4bdnoglzmbaguftcb5wzzjuar3fc6fepfwplxpay3gosbbavovjq --statements file://new_policy_state.json --version-date "2023-03-17" --config-file /home/runner/work/OCIPolicyMgmt/OCIPolicyMgmt/config --profile "DEFAULT" --debug
